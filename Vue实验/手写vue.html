<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <h1 id="app"></h1>
</body>

<script>
  // 主类
  function MyVUe(data, el, exp) {
    this.data = data;
    // 递归响应式
    observe(data);
    el.innerHTML = this.data[exp];
    // 添加依赖()
    new Watcher(this, exp, (value) => {
      el.innerHTML = value;
    })
    return this;
  }

  function observe(data) {
    if (!data || typeof data !== 'object') {
      return;
    }
    Object.keys(data).forEach(key => {
      defineReactive(data, key, data[key]);
    })
  }
  function Dep() {
    this.subs = [];
    this.target = null;
  }
  Dep.prototype = {
    addSub(sub) {
      this.subs.push(sub);
    },
    notify() {
      this.subs.forEach(sub => {
        sub.update();
      })
    }
  }
  function defineReactive(data, key, value) {
    observe(value);
    let dep = new Dep();
    Object.defineProperty(data, key, {
      enumerable: true,
      configurable: true,
      get() {
        if (Dep.target) {
          dep.addSub(Dep.target);
        }
        return value;
      },
      set(newVal) {
        if (newVal === value) {
          return;
        }
        value = newVal;
        dep.notify();
      }
    })
  }

  function Watcher(vm, exp, cb) {
    this.vm = vm;
    this.exp = exp;
    this.cb = cb;
    this.value = this.get();
  }
  Watcher.prototype = {
    // 由 Observer 触发
    update() {
      this.run();
    },
    run() {
      let newValue = this.vm.data[this.exp];
      let oldValue = this.value;
      if (newValue !== oldValue) {
        this.value = newValue;
        this.cb.call(this.vm, newValue, oldValue);
      }
    },
    get() {
      Dep.target = this;
      let value = this.vm.data[this.exp];
      Dep.target = null;
      return value;
    }
  }

  let el = document.querySelector('#app');
  let myVue = new MyVUe({
    name: 'hello world'
  }, el, 'name');

  window.setTimeout(function () {
    console.log('name值改变了');
    myVue.data.name = 'canfoo';
  }, 2000);

</script>

</html>